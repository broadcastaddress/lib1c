var RESULT export;
var VALUES export;

function test_info()
    res=new Structure();
    res.insert("name","");
    res.insert("behavior","");
    res.insert("RESULT","");
    return res;
endfunction

function split_test_name(s)
    res=new Structure("name,descr,behavior","","","");
    p=find(s,"__");
    res.name=mid(s,1,p-1);
    i=strlen(s);
    while not(mid(s,i,1)="_" and mid(s,i-1,1)="_") and i<>0 do
        i=i-1;
    enddo;
    if i<>0 then
        descr=mid(s,p+2,i-p-3);
        behavior=mid(s,i+1);
        if descr=behavior then
            behavior="";
        endif;
        res.descr=descr;
        res.behavior=behavior;
    endif;
    return res;
endfunction

function set_up(form)
    try
        res=form.set_up();
    except
        if find(errorinfo().description,"(set_up)")=0 then
            raise;
        endif;
    endtry;
    return res;
endfunction

function run_test(form,fname,args=undefined,val behavior)
    behavior=lower(behavior);
    try
        execute("form."+fname+?(args=undefined,"()","(args)"));
    except
        err=exception.catch(errorinfo());
        if find(behavior,"fail")<>0 then
            return undefined;
        endif;
        if find(behavior,"exception")<>0 or find(behavior,"error")<>0 then
            assert(lower(err.type)=behavior,"Occured exception is not expected one",
                                            new Structure("occured,expected",err.type,behavior));
            return undefined;
        endif;
        raise exception.throw();
    endtry;
    if find(behavior,"fail")<>0 
        or find(behavior,"exception")<>0 
        or find(behavior,"error")<>0 then
        assert(false,"Exception expected during this test",
                     new Structure("fname,args,behavior",fname,args,behavior));
    endif;
endfunction

function tear_down(form)
    try
        form.tear_down();
    except
        if find(errorinfo().description,"(tear_down)")=0 then
           raise;
        endif;
    endtry;
endfunction

function run() export
    res=new array();
    for each module in metadata.reports.unittest.forms do
        current_test=test_info();
        current_test.name=module.name;
        current_test.insert("tests",new structure());
        form=thisobject.getform(module.name);
        try
            suite=form.get_suite();
        except
            current_test.RESULT=RESULT.FAILED;
            current_test.insert("error",errorinfo().Description);
            continue;
        endtry;
        for each fname in suite do
            exception.clear();
            test=test_info();
            funcinfo=split_test_name(fname);
            test.name=funcinfo.name;
            test.behavior=funcinfo.behavior;
            try
                args=set_up(form);
                run_test(form,fname,args,funcinfo.behavior);
                tear_down(form);
                test.RESULT=RESULT.PASSED;
            except
                x=errorinfo();
                test.insert("error",x.Description);
                test.RESULT=RESULT.FAILED;
            endtry;
            if current_test.tests.property(funcinfo.name) then
                test.name=funcinfo.descr;
                if current_test.tests[funcinfo.name].property("tests") then
                    current_test.tests[funcinfo.name].tests.add(test)
                else
                    prev_test=current_test.tests[funcinfo.name];
                    current_test.tests[funcinfo.name]=test_info();
                    current_test.tests[funcinfo.name].name=funcinfo.name;
                    current_test.tests[funcinfo.name].insert("tests",new array());
                    current_test.tests[funcinfo.name].tests.add(prev_test);
                    current_test.tests[funcinfo.name].tests.add(test);
                endif;
            else
                if funcinfo.descr="" then
                    current_test.tests.insert(funcinfo.name,test);
                else
                    current_test.tests.insert(funcinfo.name,test_info());
                    current_test.tests[funcinfo.name].name=funcinfo.name;
                    current_test.tests[funcinfo.name].insert("tests",new array());
                    test.name=funcinfo.descr;
                    current_test.tests[funcinfo.name].tests.add(test);
                endif;
            endif;
        enddo;
        res.add(current_test);
    enddo;
    return res;
endfunction

RESULT=new Structure("PASSED,FAILED,UNKNOWN","PASSED","FAILED","UNKNOWN");

VALUES=new Structure();
    VALUES.insert("null",null);
    VALUES.insert("undefined",undefined);
    VALUES.insert("booleans",new Structure);
    VALUES.booleans.insert("true",true);
    VALUES.booleans.insert("false",false);
    VALUES.insert("numbers",new Structure);
    VALUES.numbers.insert("zero",0);
    VALUES.numbers.insert("integer",1234567890);
    VALUES.numbers.insert("real",-987654.0321);
    VALUES.numbers.insert("answer",42);
    VALUES.numbers.insert("over9k",90000000000000000000000000.00000000000000000000000009);
    VALUES.insert("strings",new Structure);
    VALUES.strings.insert("empty","");
    VALUES.strings.insert("spaced","          s"+chars.cr+"p"+chars.cr+"a"+chars.cr+"c"+chars.cr+"e"+chars.cr+"d           ");
    VALUES.strings.insert("all"," abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZАБВСГЕЁЗЖИКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯабвгеёжзийклмнопрстуфхцчшщъыьэюя1234567890~!@#$%^&*()_+,./;'\[]{}:""|<?>"+chars.cr+chars.ff+chars.tab+chars.nbsp+chars.lf+chars.vtab);
    VALUES.strings.insert("en_alpha_lcase","abcdefghijklmnopqrstuvwyz");
    VALUES.strings.insert("en_ALPHA_UCASE","ABCDEFGHIJKLMNOPQRSTUVWYZ");
    VALUES.strings.insert("ru_alpha_lcase","абвгеёжзийклмнопрстуфхцчшщъыьэюя");
    VALUES.strings.insert("ru_ALPHA_UCASE","АБВСГЕЁЗЖИКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ");
    VALUES.strings.insert("digits","1234567890");
    VALUES.strings.insert("digits2","-987654.0321");
    VALUES.strings.insert("spec_chars","~!@#$%^&*()_+,./;'\[]{}:""|<?>");
    VALUES.strings.insert("spec_chars2",chars.cr+chars.ff+chars.tab+chars.nbsp+chars.lf+chars.vtab);
    VALUES.strings.insert("date","06.06.1234 11:12:13");
    VALUES.strings.insert("date2",string(currentdate()));
    VALUES.strings.insert("uuid",string(new uuid()));
    VALUES.strings.insert("quotes","'""'""'""'""'""'""'Quote hell'""'""'""'""'""'""'""'");
    VALUES.strings.insert("moo","
                              |   ^__^
                              |   (oo)\_______
                              |   (__)\       )\/\
                              |       ||----w |
                              |       ||     ||
                              |");
    VALUES.insert("dates",new Structure());
    VALUES.dates.insert("currentdate",currentdate());
    VALUES.dates.insert("thebegining",date("00010101"));
    VALUES.insert("arrays",new Structure());
        arr=new Array();
        for i=0 to 100 do
            arr.add(?(i%2=0,i,-i)/2);
        enddo;
    VALUES.arrays.insert("numeric",arr);
        arr=new Array();
        arr.add(null);
        arr.add(undefined);
        arr.add(true);
        arr.add(false);
        arr.add(0);
        arr.add(42);
        arr.add(-3.14);
        arr.add("");
        arr.add("     ");
        arr.add("Hello, world!");
        arr.add(currentdate());
        arr.add(date("00010101"));
        arr.add(new Array());
        arr.add(new Structure());
        arr.add(new Map());
    VALUES.arrays.insert("mixed",arr);
    VALUES.insert("fixedarrays",new Structure());
    VALUES.fixedarrays.insert("numeric",new FixedArray(VALUES.arrays.numeric));